#	Copyright(c) 2018 Gluwa, Inc.
#
#	This file is part of Creditcoin.
#
#	Creditcoin is free software: you can redistribute it and/or modify
#	it under the terms of the GNU Lesser General Public License as published by
#	the Free Software Foundation, either version 3 of the License, or
#	(at your option) any later version.
#	
#	This program is distributed in the hope that it will be useful,
#	but WITHOUT ANY WARRANTY; without even the implied warranty of
#	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
#	GNU Lesser General Public License for more details.
#	
#	You should have received a copy of the GNU Lesser General Public License
#	along with Creditcoin. If not, see <https://www.gnu.org/licenses/>.

version: "3.7"

services:

  settings-tp:
    image: hyperledger/sawtooth-settings-tp:1.2.4
    container_name: sawtooth-settings-tp
    depends_on:
      - validator
    entrypoint: settings-tp -vv -C tcp://validator:4004

  validator:
    image: hyperledger/sawtooth-validator:1.2.4
    container_name: sawtooth-validator
    volumes:
      - type: volume
        source: validator-block-volume
        target: /var/lib/sawtooth/
      - type: volume
        source: validator-key-volume
        target: /etc/sawtooth/keys/
    expose:
      - 4004
      - 8800
      - 5050
    ports:
      - "4004:4004"
      - "8800:8800"
      - "5050:5050"
    entrypoint: |
      bash -c '
        if [[ ! -f /etc/sawtooth/keys/validator.pub ]]
        then 
            echo "First run"
            sawadm keygen && sawtooth-validator -vv \
                --endpoint tcp://69.172.176.206:8800 \
                --bind component:tcp://eth0:4004 \
                --bind network:tcp://eth0:8800 \
                --bind consensus:tcp://eth0:5050 \
                --peering dynamic \
                --seeds tcp://creditcoin-node.gluwa.com:8800 \
                --scheduler parallel \
                --minimum-peer-connectivity 2
        else 
            echo "Second run"
            sawtooth-validator -vv \
                --endpoint tcp://69.172.176.206:8800 \
                --bind component:tcp://eth0:4004 \
                --bind network:tcp://eth0:8800 \
                --bind consensus:tcp://eth0:5050 \
                --peering dynamic \
                --seeds tcp://creditcoin-node.gluwa.com:8800 \
                --scheduler parallel \
                --minimum-peer-connectivity 2
        fi'

  rest-api:
    image: hyperledger/sawtooth-rest-api:1.2.4
    container_name: sawtooth-rest-api
    ports:
      - "8008:8008"
    depends_on:
      - validator
    entrypoint: sawtooth-rest-api -C tcp://validator:4004 --bind rest-api:8008

  processor:
    image: gluwa/creditcoin-processor-next:nightly
    container_name: creditcoin-processor
    depends_on:
      - validator
      - settings-tp
      - rest-api
    entrypoint: |
      bash -c '
        rest_status=$$(curl -s --head -w %{http_code} http://rest-api:8008/state?address=000000 -o /dev/null)
        while [ "$$rest_status" != "200" ]
        do
            echo $$rest_status
            sleep 2
            rest_status=$$(curl -s --head -w %{http_code} http://rest-api:8008/state?address=000000 -o /dev/null)
        done
        ./ccprocessorLinux.out tcp://validator:4004 tcp://127.0.0.1:55555 http://rest-api:8008'

  consensus:
    image: gluwa/creditcoin-consensus-next:nightly
    container_name: creditcoin-consensus
    restart: always
    depends_on:
      - validator
    expose:
      - 5050
    command: ccconsensus -vv --endpoint tcp://validator:5050
    stop_signal: SIGKILL

volumes:
  validator-block-volume:
  validator-key-volume: